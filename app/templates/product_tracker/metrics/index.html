{% extends "base.html" %}
{% block title %}产品指标 - PFIS{% endblock %}
{% block content %}
<div class="page-header">
  <h2 class="page-title">产品指标管理</h2>
  <p class="page-subtitle">按产品与指标维度录入数据，Plotly 图表实时呈现趋势。</p>
</div>
<div class="space-y-6">
  <div class="card">
    <form class="grid md:grid-cols-4 gap-4 text-sm" id="metric-selector">
      <div>
        <label class="block text-slate-500 mb-1">产品</label>
        <select name="product_id" class="input" hx-get="/product_tracker/metrics/table" hx-target="#metric-table" hx-swap="outerHTML" hx-include="#metric-selector" hx-trigger="change, load">
          {% for product in products %}
          <option value="{{ product.id }}" {% if product.id == selected_product_id %}selected{% endif %}>{{ product.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-slate-500 mb-1">指标</label>
        <select name="metric_id" class="input" hx-get="/product_tracker/metrics/table" hx-target="#metric-table" hx-swap="outerHTML" hx-include="#metric-selector" hx-trigger="change, load">
          {% for metric in metrics %}
          <option value="{{ metric.id }}" {% if metric.id == selected_metric_id %}selected{% endif %}>{{ metric.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="md:col-span-2 flex items-end justify-end">
        <button
          type="button"
          class="btn-primary"
          hx-get="/product_tracker/metrics/form"
          hx-target="#metric-form-modal"
          hx-swap="innerHTML"
          hx-include="#metric-selector"
        >录入数据</button>
      </div>
    </form>
  </div>
  <div class="card">
    <div id="metric-chart" class="h-64"></div>
  </div>
  <div id="metric-table" class="card">
    {% include "product_tracker/metrics/table.html" %}
  </div>
</div>
<div id="metric-form-modal"></div>
<script>
  const layout = {margin: {t: 24, r: 16, b: 32, l: 40}, template: 'plotly_white'};
  const initialTrace = {x: {{ chart.dates | tojson }}, y: {{ chart.values | tojson }}, mode: 'lines+markers', line: {color: '#4f46e5'}};
  Plotly.newPlot('metric-chart', [initialTrace], layout, {displayModeBar: false});
  const refreshChart = () => {
    const params = new URLSearchParams(new FormData(document.getElementById('metric-selector')));
    fetch(`/product_tracker/metrics/data?${params.toString()}`)
      .then((res) => res.json())
      .then((data) => {
        const trace = {x: data.dates, y: data.values, mode: 'lines+markers', line: {color: '#4f46e5'}};
        Plotly.react('metric-chart', [trace], layout, {displayModeBar: false});
      });
  };
  document.addEventListener('htmx:afterOnLoad', (event) => {
    if (event.detail.path && event.detail.path.includes('/product_tracker/metrics')) {
      refreshChart();
    }
  });
</script>
{% endblock %}
